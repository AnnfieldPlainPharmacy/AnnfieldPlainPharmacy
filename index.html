<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pharmarota Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing:border-box; font-family:Segoe UI,Tahoma,sans-serif; }
body { background:#f5f5f5; padding:20px; }
.container { max-width:1400px; margin:auto; background:white; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
.header { background:#2c3e50; color:white; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
.week-navigation button { margin-left:6px; }
button { background:#3498db; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:13px; }
button:hover { background:#2980b9; }
.rota-container { overflow-x:auto; overflow-y:auto; max-height: calc(100vh - 320px); }
.rota-table { width:100%; border-collapse:collapse; min-width:1200px; }
.rota-table th, .rota-table td { border:1px solid #ddd; padding:4px 6px; text-align:center; font-size:13px; }
.rota-table th { background:#ecf0f1; position:sticky; top:0; }
.employee-name { background:#f8f9fa; font-weight:600; min-width:220px; cursor:pointer; font-size:12px; padding:4px 6px; }
.department-header { background:#34495e; color:white; font-weight:600; text-align:left; }

tr.department-row td.department-header { background: #34495e !important; color: #ffffff !important; }
tr.dept-medipak.employee-row td:not(.total-hours):not(.shift-holiday):not(.shift-sick):not(.today-col) { background: #fbf8ff; }
tr.dept-counter.employee-row td:not(.total-hours):not(.shift-holiday):not(.shift-sick):not(.today-col) { background: #fff7f7; }
tr.dept-dispensary.employee-row td:not(.total-hours):not(.shift-holiday):not(.shift-sick):not(.today-col) { background: #f3fbf3; }

.shift-cell { cursor:pointer; position:relative; font-size:13px; }
.shift-holiday { background:#ffeb3b !important; font-weight:700; color:#1f1f1f !important; }
.shift-sick { background:#03a9f4 !important; font-weight:700; color:#ffffff !important; }
.total-hours { background:#e8f4fc; font-weight:600; }
.employee-row:hover { background:#f1f8ff; }
.delete { color:#e74c3c; cursor:pointer; font-weight:bold; }
.controls { padding:15px; background:#f8f9fa; display:flex; gap:10px; }
.notes-section { padding:14px 16px; border-top:1px solid #ddd; background:#f8f9fa; }
.notes-section textarea { width:100%; min-height:90px; padding:10px; font-size:13px; }
.status-bar { padding:10px; font-size:13px; color:#555; text-align:right; }

.dispensary-total-row td { background: #d9edf7; font-weight: 700; }
.dispensary-total-row .label { text-align: left; }

th.today-col, td.today-col { background: #f2f2f2 !important; color: #111 !important; }

/* Context menu */
.context-menu{
  position: fixed;
  z-index: 9999;
  display: none;
  min-width: 180px;
  background: #ffffff;
  border: 1px solid #dcdcdc;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  overflow: hidden;
}
.context-menu button{
  width: 100%;
  text-align: left;
  background: transparent;
  color: #2c3e50;
  border: 0;
  padding: 10px 12px;
  border-radius: 0;
  font-size: 13px;
  cursor: pointer;
}
.context-menu button:hover{ background: #f3f6f9; }
.context-menu .danger{ color:#c0392b; }
.context-menu .divider{ height:1px; background:#eeeeee; }

.context-menu .has-submenu{ position: relative; }
.context-menu .arrow{ float:right; opacity:0.7; }
.context-submenu{
  position: fixed;
  z-index: 10000;
  display: none;
  min-width: 170px;
  background: #ffffff;
  border: 1px solid #dcdcdc;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  overflow: hidden;
}
.context-submenu button{ width:100%; text-align:left; background:transparent; color:#2c3e50; border:0; padding:10px 12px; font-size:13px; cursor:pointer; }
.context-submenu button:hover{ background:#f3f6f9; }
.context-submenu .danger{ color:#c0392b; }
.context-submenu .divider{ height:1px; background:#eeeeee; }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1 style="margin:0;font-size:20px;line-height:1.15;">Pharmarota Pro<br><small id="printWeek" style="font-size:12px;opacity:0.9;"></small></h1>
    <div class="week-navigation">
      <button id="prevWeek">‚óÄ</button>
      <span id="weekDisplay"></span>
      <button id="nextWeek">‚ñ∂</button>
      <button id="currentWeek">Current</button>
    </div>
  </div>

  <div class="rota-container">
    <table class="rota-table" id="rotaTable"></table>
  </div>

  <div class="controls">
    <button id="saveRota">Save</button>
    <button onclick="window.print()">Print</button>
  </div>

  <div class="notes-section">
    <h3 style="margin:0 0 8px 0;">üìù Notes</h3>
    <textarea id="rotaNotes" placeholder="Enter notes here...(e.g...Holiday requests, special instructions, reminders)"></textarea>
  </div>

  <div class="status-bar">
    <span id="lastSaved"></span>
  </div>
</div>

<!-- Right-click menu for shift cells -->
<div id="contextMenu" class="context-menu" role="menu" aria-hidden="true">
  <button type="button" onclick="contextWorking()">‚úèÔ∏è Working (edit shift)</button>
  <button type="button" onclick="contextSet('HOLIDAY')">üèñÔ∏è Holiday</button>
  <button type="button" onclick="contextSet('SICK')">ü§í Sickness</button>
  <button type="button" class="has-submenu" onmouseenter="openBreakSubmenu()" onclick="toggleBreakSubmenu(event)">‚è±Ô∏è Break <span class="arrow">‚ñ∂</span></button>
  <div id="breakSubMenu" class="context-submenu" aria-hidden="true">
    <button type="button" onclick="contextSetBreak(0)">0 min</button>
    <button type="button" onclick="contextSetBreak(30)">30 min</button>
    <button type="button" onclick="contextSetBreak(60)">60 min</button>
    <div class="divider"></div>
    <button type="button" onclick="contextFreeTypeBreak()">Free type‚Ä¶</button>
    <button type="button" class="danger" onclick="contextClearBreak()">Clear manual break</button>
  </div>
  <div class="divider"></div>
  <button type="button" class="danger" onclick="contextSet('')">üßΩ Clear</button>
</div>

<script>
/* =========================
   Google Sheets Web App API
   ========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxr7a3Fz9sQgkOJMPT5twHkLyPFkTo9HUImVK2Q_Hw9zrwpjNck15-x3TgPjVlI7WAg/exec";

async function apiGetRota(weekStart, department) {
  const url = `${API_URL}?weekStart=${encodeURIComponent(weekStart)}&department=${encodeURIComponent(department)}`;
  const res = await fetch(url, { method: "GET" });
  return await res.json();
}

// DIAGNOSTIC: minimal POST ping (no headers)
async function apiPingPost(){
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ ping: true, ts: new Date().toISOString() })
  });
  return await res.text();
}

/* =========================
   Data
   ========================= */
let currentWeekOffset = 0;
let weekNotes = "";

const templateData = [
  { department: "Medipak", employees: [{ name: "Rachel Stoker", shifts: ["9-6","13:00-18:00","9-6","","","",""] }] },
  { department: "Counter Staff", employees: [
      { name: "Allison Hole", shifts: ["9-12","9-12","9-1","9-1","9-1","",""] },
      { name: "Della Stait", shifts: ["12-6","","","13:00-18:00","13:00-18:00","",""] }
    ]
  },
  { department: "Dispensary", employees: [
      { name: "Jude Taylor", shifts: ["9-6","9-6","9-6","9-6","9-6","",""] },
      { name: "Jane Vickers", shifts: ["9-6","","9-6","9-3","","",""] },
      { name: "Olivia Pharoah", shifts: ["9-6","9-6","9-6","9-6","9-6","",""] }
    ]
  },
  { department: "_", employees: [{ name: "Wendy Anderson", shifts: ["9-3","9-3","","9-3","9-3","",""] }] }
];

let currentData = JSON.parse(JSON.stringify(templateData));

/* =========================
   Helpers
   ========================= */
function getWeekDates(offset=0){
  const now=new Date();
  const base=new Date(now.getFullYear(),now.getMonth(),now.getDate()+offset*7);
  const day=base.getDay();
  const diff=day===0?-6:1-day;
  const monday=new Date(base);
  monday.setDate(base.getDate()+diff);
  return Array.from({length:7},(_,i)=>new Date(monday.getFullYear(),monday.getMonth(),monday.getDate()+i));
}
function getWeekStartISO(){
  return getWeekDates(currentWeekOffset)[0].toISOString().slice(0,10);
}
function getWeekKey(){ return "rota_"+getWeekStartISO(); }

function isToday(d){
  const now = new Date();
  return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
}
function ordinal(n){
  const s = ["th","st","nd","rd"];
  const v = n % 100;
  return n + (s[(v-20)%10] || s[v] || s[0]);
}
function formatHeaderDate(d){
  const wd = d.toLocaleDateString("en-GB", { weekday: "short" });
  const mon = d.toLocaleDateString("en-GB", { month: "short" });
  return `${wd} ${ordinal(d.getDate())} ${mon}`;
}
function normaliseShift(v){
  if(!v) return "";
  v = String(v).toLowerCase().trim();
  v = v.replace(/[‚Äì‚Äî]/g,"-").replace(/\s+to\s+/g,"-").replace(/\s+/g,"-");
  if(v==="h" || v==="hol" || v==="holiday") return "HOLIDAY";
  if(v==="s" || v==="sick") return "SICK";
  if(!/^\d{1,2}(:\d{2})?-\d{1,2}(:\d{2})?$/.test(v)) return "";
  let[a,b]=v.split("-");
  function toTime(t){
    if(!t.includes(":")) t+=":00";
    let[h,m]=t.split(":").map(Number);
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }
  let start=toTime(a);
  let endH=parseInt(b);
  let startH=parseInt(a);
  if(endH<=startH) endH+=12;
  let end=`${String(endH).padStart(2,"0")}:00`;
  return `${start}-${end}`;
}

// Break overrides: "09:00-18:00|B30"
function parseBreak(raw){
  if(!raw) return { base: "", br: null };
  const parts = String(raw).split("|B");
  if(parts.length === 2){
    const mins = Number(parts[1]);
    if(Number.isFinite(mins) && mins >= 0) return { base: parts[0], br: mins };
  }
  return { base: String(raw), br: null };
}
function breakMinutes(shift){
  const { base, br } = parseBreak(shift);
  if(!base || base==="HOLIDAY" || base==="SICK") return 0;
  if(br !== null) return br;
  const [s,e] = normaliseShift(base).split("-");
  const [sh,sm] = s.split(":").map(Number);
  const [eh,em] = e.split(":").map(Number);
  let mins = (eh*60+em) - (sh*60+sm);
  return mins >= 9*60 ? 60 : 0;
}
function hours(shift){
  const { base } = parseBreak(shift);
  if(!base || base==="HOLIDAY" || base==="SICK") return 0;
  const [s,e] = normaliseShift(base).split("-");
  const [sh,sm] = s.split(":").map(Number);
  const [eh,em] = e.split(":").map(Number);
  let mins = (eh*60+em) - (sh*60+sm);
  mins -= breakMinutes(shift);
  return Math.max(0, mins / 60);
}
function deptClass(deptName){
  const n = (deptName||"").toLowerCase();
  if(n.includes("medipak")) return "dept-medipak";
  if(n.includes("counter")) return "dept-counter";
  if(n.includes("dispensary")) return "dept-dispensary";
  return "";
}

/* =========================
   Render
   ========================= */
function render() {
  const table = document.getElementById("rotaTable");
  table.innerHTML = "";

  const weekDisplay = document.getElementById("weekDisplay");
  const printWeek = document.getElementById("printWeek");

  const days = getWeekDates(currentWeekOffset);
  weekDisplay.textContent = `${days[0].toLocaleDateString("en-GB")} - ${days[6].toLocaleDateString("en-GB")}`;
  printWeek.textContent = "Week commencing " + days[0].toLocaleDateString("en-GB");

  let header = `<tr><th></th><th>Employee</th>`;
  header += days.map(d => `<th class="${isToday(d)?"today-col":""}">${formatHeaderDate(d)}</th>`).join("");
  header += `<th>Total</th></tr>`;
  table.innerHTML += header;

  currentData.forEach((dept, di) => {
    const dClass = deptClass(dept.department);
    table.innerHTML += `
      <tr class="department-row ${dClass}" data-dept="${di}" ondragover="allowDrop(event)" ondrop="dropOnDepartment(event)">
        <td colspan="10" class="department-header">
          <span class="dept-name" ondblclick="editDepartment(this,${di})">${dept.department}</span>
          <button class="add-btn" onclick="addEmployee(${di})">+</button>
        </td>
      </tr>
    `;

    dept.employees.forEach((emp, ei) => {
      let total = 0;
      let row = `<tr class="employee-row ${dClass}" draggable="true"
                      data-dept="${di}" data-emp="${ei}"
                      ondragstart="dragEmployee(event)"
                      ondragover="allowDrop(event)"
                      ondrop="dropEmployee(event)">`;

      row += `<td class="delete" onclick="delEmp(${di},${ei})">√ó</td>`;
      row += `<td class="employee-name" ondblclick="editName(this,${di},${ei})">${emp.name}</td>`;

      for (let si = 0; si < 7; si++) {
        const raw = (emp.shifts && emp.shifts[si]) ? emp.shifts[si] : "";
        const parsed = parseBreak(raw);
        const base = parsed.base || "";
        const norm = base ? normaliseShift(base) : "";
        const display = (norm === "HOLIDAY") ? "HOL" : (norm === "SICK") ? "SICK" : norm;
        total += hours(raw);

        const klass =
          norm === "HOLIDAY" ? "shift-holiday" :
          norm === "SICK" ? "shift-sick" : "";

        const todayClass = isToday(days[si]) ? 'today-col' : '';
        row += `<td class="shift-cell ${klass} ${todayClass}"
                    data-di="${di}" data-ei="${ei}" data-si="${si}"
                    title="${breakMinutes(raw)} min"
                    onclick="editShift(this,${di},${ei},${si})"
                    oncontextmenu="openContextMenu(event,${di},${ei},${si})">${display}</td>`;
      }

      row += `<td class="total-hours">${total.toFixed(1)}</td>`;
      row += `</tr>`;
      table.innerHTML += row;
    });

    if (dept.department === "Dispensary") {
      const dayTotals = [0,0,0,0,0,0,0];
      dept.employees.forEach(emp => {
        for (let si = 0; si < 7; si++) {
          const raw = (emp.shifts && emp.shifts[si]) ? emp.shifts[si] : "";
          dayTotals[si] += hours(raw);
        }
      });
      const weekTotal = dayTotals.reduce((a,b) => a + b, 0);

      let totalRow = `<tr class="dispensary-total-row">`;
      totalRow += `<td></td>`;
      totalRow += `<td class="label">Dispensary hours</td>`;
      for (let i = 0; i < 7; i++) totalRow += `<td>${dayTotals[i].toFixed(1)}</td>`;
      totalRow += `<td class="total-hours">${weekTotal.toFixed(1)}</td>`;
      totalRow += `</tr>`;
      table.innerHTML += totalRow;
    }
  });

  document.getElementById("rotaNotes").value = weekNotes;
}

/* =========================
   Minimal edit support (enough to run the diagnostic)
   ========================= */
function editShift(cell,di,ei,si){
  const currentRaw = currentData[di].employees[ei].shifts[si] || "";
  const input = document.createElement("input");
  input.value = currentRaw || "";
  cell.innerHTML = "";
  cell.appendChild(input);
  input.focus();
  input.select();

  input.onblur = ()=>{
    currentData[di].employees[ei].shifts[si] = input.value.trim();
    render();
  };
  input.onkeydown = (e)=>{
    if(e.key === "Enter") input.blur();
    if(e.key === "Escape"){ render(); closeContextMenu(); }
  };
}
function editName(td,di,ei){
  const input=document.createElement("input");
  input.value=td.textContent;
  td.innerHTML=""; td.appendChild(input); input.focus();
  input.select();
  input.onblur=()=>{ currentData[di].employees[ei].name=input.value.trim()||"Unnamed"; render(); };
}
function editDepartment(span,di){
  const input=document.createElement("input");
  input.value=span.textContent;
  span.replaceWith(input); input.focus();
  input.onblur=()=>{ currentData[di].department=input.value.trim(); render(); };
}
function addEmployee(di){ currentData[di].employees.push({name:"New Employee",shifts:["","","","","","",""]}); render(); }
function delEmp(di,ei){ if(confirm("Delete employee?")){ currentData[di].employees.splice(ei,1); render(); } }

let draggedEmployee=null;
function dragEmployee(e){ const r=e.currentTarget; draggedEmployee={fromDept:+r.dataset.dept, fromIndex:+r.dataset.emp}; r.style.opacity="0.5"; }
function allowDrop(e){ e.preventDefault(); }
function dropEmployee(e){
  e.preventDefault(); if(!draggedEmployee) return;
  const toDept=+e.currentTarget.dataset.dept;
  const toIndex=+e.currentTarget.dataset.emp;
  const {fromDept,fromIndex}=draggedEmployee;
  const emp=currentData[fromDept].employees.splice(fromIndex,1)[0];
  currentData[toDept].employees.splice(toIndex,0,emp);
  draggedEmployee=null; render();
}
function dropOnDepartment(e){
  e.preventDefault(); if(!draggedEmployee) return;
  const toDept=+e.currentTarget.dataset.dept;
  const {fromDept,fromIndex}=draggedEmployee;
  const emp=currentData[fromDept].employees.splice(fromIndex,1)[0];
  currentData[toDept].employees.push(emp);
  draggedEmployee=null; render();
}
document.addEventListener("dragend",()=>{ document.querySelectorAll(".employee-row").forEach(r=>r.style.opacity="1"); });

/* =========================
   Context menu (kept, but OK if unused)
   ========================= */
let contextTarget = null;
function closeBreakSubmenu(){
  const sub = document.getElementById('breakSubMenu');
  if(!sub) return;
  sub.style.display = 'none';
  sub.setAttribute('aria-hidden','true');
}
closeBreakSubmenu();

function openContextMenu(e, di, ei, si){
  e.preventDefault();
  contextTarget = {di, ei, si};
  const menu = document.getElementById('contextMenu');
  if(!menu) return;

  const pad = 8;
  menu.style.display = 'block';
  const { innerWidth:w, innerHeight:h } = window;
  const rect = menu.getBoundingClientRect();

  let x = e.clientX;
  let y = e.clientY;
  if(x + rect.width + pad > w) x = w - rect.width - pad;
  if(y + rect.height + pad > h) y = h - rect.height - pad;

  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.setAttribute('aria-hidden','false');
  closeBreakSubmenu();
}
function closeContextMenu(){
  const menu = document.getElementById('contextMenu');
  if(!menu) return;
  menu.style.display = 'none';
  menu.setAttribute('aria-hidden','true');
  contextTarget = null;
  closeBreakSubmenu();
}
function contextSet(val){
  if(!contextTarget) return;
  const {di, ei, si} = contextTarget;
  currentData[di].employees[ei].shifts[si] = val;
  render();
  closeContextMenu();
}
function contextWorking(){
  if(!contextTarget) return;
  const {di, ei, si} = contextTarget;
  closeContextMenu();
  const cell = document.querySelector(`.shift-cell[data-di="${di}"][data-ei="${ei}"][data-si="${si}"]`);
  if(cell) editShift(cell, di, ei, si);
}
function openBreakSubmenu(){ /* not used in diagnostic */ }
function toggleBreakSubmenu(e){ e.preventDefault(); }
function contextSetBreak(mins){ alert("Break menu not used in diagnostic build."); }
function contextClearBreak(){ alert("Break menu not used in diagnostic build."); }
function contextFreeTypeBreak(){ alert("Break menu not used in diagnostic build."); }

document.addEventListener('click', (e)=>{
  const menu = document.getElementById('contextMenu');
  if(!menu || menu.style.display !== 'block') return;
  if(!menu.contains(e.target)) closeContextMenu();
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){ closeContextMenu(); return; }
});
window.addEventListener('scroll', ()=> closeContextMenu(), true);
window.addEventListener('resize', ()=> closeContextMenu());

/* =========================
   Init + DIAGNOSTIC Save button
   ========================= */
function initRota(){
  render();

  // DIAGNOSTIC: Save button performs POST ping and displays result
  document.getElementById("saveRota").onclick = async () => {
    const ls = document.getElementById("lastSaved");
    ls.textContent = "POST testing‚Ä¶";
    try{
      const t = await apiPingPost();
      ls.textContent = "POST replied: " + String(t).slice(0, 120);
    } catch(e){
      ls.textContent = "POST failed: " + (e && e.message ? e.message : String(e));
    }
  };

  document.getElementById("prevWeek").onclick = async () => { currentWeekOffset--; render(); };
  document.getElementById("nextWeek").onclick = async () => { currentWeekOffset++; render(); };
  document.getElementById("currentWeek").onclick = async () => { currentWeekOffset=0; render(); };
}

if (document.readyState === "loading") {
  window.addEventListener("DOMContentLoaded", initRota);
} else {
  initRota();
}
</script>
</body>
</html>
