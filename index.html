<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxr7a3Fz9sQgkOJMPT5twHkLyPFkTo9HUImVK2Q_Hw9zrwpjNck15-x3TgPjVlI7WAg/exec";

async function apiGetRota(weekStart, department) {
  const url = `${API_URL}?weekStart=${encodeURIComponent(weekStart)}&department=${encodeURIComponent(department)}`;
  const res = await fetch(url, { method: "GET" });
  return await res.json();
}

async function apiSaveUpserts(upserts) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ upserts })
  });
  return await res.json();
}

let currentWeekOffset = 0;
let weekNotes = "";

const templateData = [
  { department: "Medipak", employees: [{ name: "Rachel Stoker", shifts: ["9-6","13:00-18:00","9-6","","","",""] }] },
  { department: "Counter Staff", employees: [
      { name: "Allison Hole", shifts: ["9-12","9-12","9-1","9-1","9-1","",""] },
      { name: "Della Stait", shifts: ["12-6","","","13:00-18:00","13:00-18:00","",""] }
    ]
  },
  { department: "Dispensary", employees: [
      { name: "Jude Taylor", shifts: ["9-6","9-6","9-6","9-6","9-6","",""] },
      { name: "Jane Vickers", shifts: ["9-6","","9-6","9-3","","",""] },
      { name: "Olivia Pharoah", shifts: ["9-6","9-6","9-6","9-6","9-6","",""] }
    ]
  },
  { department: "_", employees: [{ name: "Wendy Anderson", shifts: ["9-3","9-3","","9-3","9-3","",""] }] }
];

let currentData = JSON.parse(JSON.stringify(templateData));

function getWeekDates(offset=0){
  const now=new Date();
  const base=new Date(now.getFullYear(),now.getMonth(),now.getDate()+offset*7);
  const day=base.getDay();
  const diff=day===0?-6:1-day;
  const monday=new Date(base);
  monday.setDate(base.getDate()+diff);
  return Array.from({length:7},(_,i)=>new Date(monday.getFullYear(),monday.getMonth(),monday.getDate()+i));
}
function getWeekStartISO(){
  return getWeekDates(currentWeekOffset)[0].toISOString().slice(0,10); // YYYY-MM-DD (Monday)
}
function isToday(d){
  const now = new Date();
  return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth() && d.getDate()===now.getDate();
}

function ordinal(n){
  const s = ["th","st","nd","rd"];
  const v = n % 100;
  return n + (s[(v-20)%10] || s[v] || s[0]);
}
function formatHeaderDate(d){
  const wd = d.toLocaleDateString("en-GB", { weekday: "short" });
  const mon = d.toLocaleDateString("en-GB", { month: "short" });
  return `${wd} ${ordinal(d.getDate())} ${mon}`;
}

function getWeekKey(){ return "rota_"+getWeekStartISO(); }

function normaliseShift(v){
  if(!v) return "";
  v = String(v).toLowerCase().trim();

  v = v.replace(/[–—]/g,"-").replace(/\s+to\s+/g,"-").replace(/\s+/g,"-");

  if(v==="h" || v==="hol" || v==="holiday") return "HOLIDAY";
  if(v==="s" || v==="sick") return "SICK";

  if(!/^\d{1,2}(:\d{2})?-\d{1,2}(:\d{2})?$/.test(v)) return "";

  let[a,b]=v.split("-");
  function toTime(t){
    if(!t.includes(":")) t+=":00";
    let[h,m]=t.split(":").map(Number);
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }
  let start=toTime(a);
  let endH=parseInt(b);
  let startH=parseInt(a);
  if(endH<=startH) endH+=12;
  let end=`${String(endH).padStart(2,"0")}:00`;
  return `${start}-${end}`;
}

// ---- Break overrides ----
function parseBreak(raw){
  if(!raw) return { base: "", br: null };
  const parts = String(raw).split("|B");
  if(parts.length === 2){
    const mins = Number(parts[1]);
    if(Number.isFinite(mins) && mins >= 0) return { base: parts[0], br: mins };
  }
  return { base: String(raw), br: null };
}
function withBreak(base, br){
  if(!base) return "";
  if(base === "HOLIDAY" || base === "SICK") return base;
  if(br === null || br === undefined) return base;
  const mins = Math.max(0, Math.round(Number(br)));
  return `${base}|B${mins}`;
}
function breakMinutes(shift){
  const { base, br } = parseBreak(shift);
  if(!base || base==="HOLIDAY" || base==="SICK") return 0;
  if(br !== null) return br;
  const [s,e] = normaliseShift(base).split("-");
  const [sh,sm] = s.split(":").map(Number);
  const [eh,em] = e.split(":").map(Number);
  let mins = (eh*60+em) - (sh*60+sm);
  return mins >= 9*60 ? 60 : 0;
}
function hours(shift){
  const { base } = parseBreak(shift);
  if(!base || base==="HOLIDAY" || base==="SICK") return 0;
  const [s,e] = normaliseShift(base).split("-");
  const [sh,sm] = s.split(":").map(Number);
  const [eh,em] = e.split(":").map(Number);
  let mins = (eh*60+em) - (sh*60+sm);
  mins -= breakMinutes(shift);
  return Math.max(0, mins / 60);
}

function deptClass(deptName){
  const n = (deptName||"").toLowerCase();
  if(n.includes("medipak")) return "dept-medipak";
  if(n.includes("counter")) return "dept-counter";
  if(n.includes("dispensary")) return "dept-dispensary";
  return "";
}

function render() {
  const table = document.getElementById("rotaTable");
  table.innerHTML = "";

  const days = getWeekDates(currentWeekOffset);

  weekDisplay.textContent = `${days[0].toLocaleDateString("en-GB")} - ${days[6].toLocaleDateString("en-GB")}`;
  printWeek.textContent = "Week commencing " + days[0].toLocaleDateString("en-GB");

  let header = `<tr><th></th><th>Employee</th>`;
  header += days.map(d => `<th class="${isToday(d)?"today-col":""}">${formatHeaderDate(d)}</th>`).join("");
  header += `<th>Total</th></tr>`;
  table.innerHTML += header;

  currentData.forEach((dept, di) => {
    const dClass = deptClass(dept.department);
    table.innerHTML += `
      <tr class="department-row ${dClass}" data-dept="${di}" ondragover="allowDrop(event)" ondrop="dropOnDepartment(event)">
        <td colspan="10" class="department-header">
          <span class="dept-name" ondblclick="editDepartment(this,${di})">${dept.department}</span>
          <button class="add-btn" onclick="addEmployee(${di})">+</button>
        </td>
      </tr>
    `;

    dept.employees.forEach((emp, ei) => {
      let total = 0;

      let row = `<tr class="employee-row ${dClass}" draggable="true"
                      data-dept="${di}" data-emp="${ei}"
                      ondragstart="dragEmployee(event)"
                      ondragover="allowDrop(event)"
                      ondrop="dropEmployee(event)">`;

      row += `<td class="delete" onclick="delEmp(${di},${ei})">×</td>`;
      row += `<td class="employee-name" ondblclick="editName(this,${di},${ei})">${emp.name}</td>`;

      for (let si = 0; si < 7; si++) {
        const raw = (emp.shifts && emp.shifts[si]) ? emp.shifts[si] : "";
        const parsed = parseBreak(raw);
        const base = parsed.base || "";
        const norm = base ? normaliseShift(base) : "";
        const display = (norm === "HOLIDAY") ? "HOL" : (norm === "SICK") ? "SICK" : norm;
        total += hours(raw);

        const klass =
          norm === "HOLIDAY" ? "shift-holiday" :
          norm === "SICK" ? "shift-sick" : "";

        const todayClass = isToday(days[si]) ? 'today-col' : '';
        row += `<td class="shift-cell ${klass} ${todayClass}"
                    data-di="${di}" data-ei="${ei}" data-si="${si}"
                    title="${breakMinutes(raw)} min"
                    onclick="editShift(this,${di},${ei},${si})"
                    oncontextmenu="openContextMenu(event,${di},${ei},${si})">${display}</td>`;
      }

      row += `<td class="total-hours">${total.toFixed(1)}</td>`;
      row += `</tr>`;

      table.innerHTML += row;
    });

    if (dept.department === "Dispensary") {
      const dayTotals = [0, 0, 0, 0, 0, 0, 0];
      dept.employees.forEach(emp => {
        for (let si = 0; si < 7; si++) {
          const raw = (emp.shifts && emp.shifts[si]) ? emp.shifts[si] : "";
          dayTotals[si] += hours(raw);
        }
      });
      const weekTotal = dayTotals.reduce((a, b) => a + b, 0);

      let totalRow = `<tr class="dispensary-total-row">`;
      totalRow += `<td></td>`;
      totalRow += `<td class="label">Dispensary hours</td>`;
      for (let i = 0; i < 7; i++) totalRow += `<td>${dayTotals[i].toFixed(1)}</td>`;
      totalRow += `<td class="total-hours">${weekTotal.toFixed(1)}</td>`;
      totalRow += `</tr>`;

      table.innerHTML += totalRow;
    }
  });

  document.getElementById("rotaNotes").value = weekNotes;
}

async function saveCurrentWeekToSheet(){
  const weekStart = getWeekStartISO();
  const days = getWeekDates(currentWeekOffset);

  const upserts = [];
  currentData.forEach(dept => {
    const department = (dept.department || "").trim();
    dept.employees.forEach(emp => {
      const employee = (emp.name || "").trim();
      for(let si=0; si<7; si++){
        const date = days[si].toISOString().slice(0,10);
        const raw = (emp.shifts && emp.shifts[si]) ? emp.shifts[si] : "";
        const { base } = parseBreak(raw);
        const norm = base ? normaliseShift(base) : "";

        let status = "";
        let start = "";
        let end = "";

        if(norm === "HOLIDAY") {
          status = "HOLIDAY";
        } else if(norm === "SICK") {
          status = "SICK";
        } else if(norm) {
          status = "WORK";
          const parts = norm.split("-");
          start = parts[0] || "";
          end = parts[1] || "";
        } else {
          status = ""; // cleared
        }

        upserts.push({ weekStart, department, employee, date, status, start, end });
      }
    });
  });

  const res = await apiSaveUpserts(upserts);
  if(res && res.error){
    lastSaved.textContent = `Save failed: ${res.error}`;
    return false;
  }
  lastSaved.textContent = "Saved to shared sheet";
  return true;
}

let saveTimer = null;
function queueSaveToSheet(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async () => {
    await saveCurrentWeekToSheet();
  }, 800);
}

function autoSaveWeek(){
  weekNotes = document.getElementById("rotaNotes").value;

  // keep local fallback
  localStorage.setItem(getWeekKey(), JSON.stringify({data: currentData, notes: weekNotes}));
  lastSaved.textContent = "Auto-saved";

  // shared save
  queueSaveToSheet();
}

async function loadWeekFromSheet(){
  const weekStart = getWeekStartISO();

  // We fetch all rows for this week (no department filter) and overlay them into the template structure.
  const result = await apiGetRota(weekStart, "");

  if (result && result.error) {
    lastSaved.textContent = `Load failed: ${result.error}`;
    return false;
  }

  const rows = (result && result.rows) ? result.rows : [];
  if(!rows.length){
    // Nothing in sheet yet; keep template (or local fallback will apply in loadWeek)
    return true;
  }

  // reset to template then apply sheet rows
  currentData = JSON.parse(JSON.stringify(templateData));
  const days = getWeekDates(currentWeekOffset);

  function dayIndex(dateStr){
    for(let i=0;i<7;i++){
      if(days[i].toISOString().slice(0,10) === dateStr) return i;
    }
    return -1;
  }

  function getOrCreateDept(deptName){
    let d = currentData.find(x => (x.department||"") === deptName);
    if(!d){
      d = { department: deptName, employees: [] };
      currentData.push(d);
    }
    return d;
  }
  function getOrCreateEmp(deptObj, empName){
    let e = deptObj.employees.find(x => (x.name||"") === empName);
    if(!e){
      e = { name: empName, shifts: ["","","","","","",""] };
      deptObj.employees.push(e);
    }
    return e;
  }

  rows.forEach(r => {
    const si = dayIndex(r.date);
    if(si < 0) return;

    const deptName = (r.department || "").trim();
    const empName = (r.employee || "").trim();
    if(!deptName || !empName) return;

    const dept = getOrCreateDept(deptName);
    const emp = getOrCreateEmp(dept, empName);

    const status = (r.status || "").toUpperCase().trim();
    if(status === "HOLIDAY") {
      emp.shifts[si] = "HOLIDAY";
    } else if(status === "SICK") {
      emp.shifts[si] = "SICK";
    } else if(status === "WORK") {
      const start = (r.start || "").trim();
      const end = (r.end || "").trim();
      emp.shifts[si] = (start && end) ? `${start}-${end}` : "";
    } else {
      emp.shifts[si] = "";
    }
  });

  lastSaved.textContent = "Loaded from shared sheet";
  return true;
}

async function loadWeek(){
  // Try shared sheet first
  const ok = await loadWeekFromSheet();
  if (ok) {
    // If sheet is empty, try local fallback for this device
    const saved = localStorage.getItem(getWeekKey());
    if(saved){
      const parsed = JSON.parse(saved);
      // Only use local if it has something meaningful
      if(parsed && parsed.data) {
        currentData = parsed.data;
        weekNotes = parsed.notes || "";
      }
    }
    render();
    return;
  }

  // fallback: local only
  const saved = localStorage.getItem(getWeekKey());
  if(saved){
    const parsed = JSON.parse(saved);
    currentData = parsed.data || JSON.parse(JSON.stringify(templateData));
    weekNotes = parsed.notes || "";
    lastSaved.textContent = "Loaded from this device";
  } else {
    currentData = JSON.parse(JSON.stringify(templateData));
    weekNotes = "";
  }
  render();
}

// --- Your existing UI actions (unchanged except they call autoSaveWeek+render already) ---
function setSick(di, ei, si){
  const cur = currentData[di].employees[ei].shifts[si] || "";
  currentData[di].employees[ei].shifts[si] = (cur === "SICK") ? "" : "SICK";
  autoSaveWeek();
  render();
}
function setHoliday(di, ei, si){
  const cur = currentData[di].employees[ei].shifts[si] || "";
  currentData[di].employees[ei].shifts[si] = (cur === "HOLIDAY") ? "" : "HOLIDAY";
  autoSaveWeek();
  render();
}

function editShift(cell,di,ei,si){
  const currentRaw = currentData[di].employees[ei].shifts[si] || "";
  const parsed = parseBreak(currentRaw);
  const existingBreak = parsed.br;

  const input = document.createElement("input");
  input.value = parsed.base || "";
  cell.innerHTML = "";
  cell.appendChild(input);
  input.focus();

  input.select();
  input.onblur = ()=>{
    const newBase = normaliseShift(input.value);
    let next;
    if(!newBase || newBase === "HOLIDAY" || newBase === "SICK"){
      next = newBase || "";
    } else {
      next = withBreak(newBase, existingBreak);
    }
    currentData[di].employees[ei].shifts[si] = next;
    autoSaveWeek();
    render();
  };

  input.onkeydown = (e)=>{
    if(e.key === "Enter") input.blur();
    if(e.key === "Escape"){
      render();
      closeContextMenu();
    }
  };
}

function editName(td,di,ei){
  const input=document.createElement("input");
  input.value=td.textContent;
  td.innerHTML=""; td.appendChild(input); input.focus();
  input.select();
  input.onblur=()=>{ currentData[di].employees[ei].name=input.value.trim()||"Unnamed"; autoSaveWeek(); render(); };
}
function editDepartment(span,di){
  const input=document.createElement("input");
  input.value=span.textContent;
  span.replaceWith(input); input.focus();
  input.onblur=()=>{ currentData[di].department=input.value.trim(); autoSaveWeek(); render(); };
}
function addEmployee(di){ currentData[di].employees.push({name:"New Employee",shifts:["","","","","","",""]}); autoSaveWeek(); render(); }
function delEmp(di,ei){ if(confirm("Delete employee?")){ currentData[di].employees.splice(ei,1); autoSaveWeek(); render(); } }

let draggedEmployee=null;
function dragEmployee(e){ const r=e.currentTarget; draggedEmployee={fromDept:+r.dataset.dept, fromIndex:+r.dataset.emp}; r.style.opacity="0.5"; }
function allowDrop(e){ e.preventDefault(); }
function dropEmployee(e){
  e.preventDefault(); if(!draggedEmployee) return;
  const toDept=+e.currentTarget.dataset.dept;
  const toIndex=+e.currentTarget.dataset.emp;
  const {fromDept,fromIndex}=draggedEmployee;
  const emp=currentData[fromDept].employees.splice(fromIndex,1)[0];
  currentData[toDept].employees.splice(toIndex,0,emp);
  draggedEmployee=null; autoSaveWeek(); render();
}
function dropOnDepartment(e){
  e.preventDefault(); if(!draggedEmployee) return;
  const toDept=+e.currentTarget.dataset.dept;
  const {fromDept,fromIndex}=draggedEmployee;
  const emp=currentData[fromDept].employees.splice(fromIndex,1)[0];
  currentData[toDept].employees.push(emp);
  draggedEmployee=null; autoSaveWeek(); render();
}
document.addEventListener("dragend",()=>{ document.querySelectorAll(".employee-row").forEach(r=>r.style.opacity="1"); });

// --- Context menu (unchanged) ---
let contextTarget = null;
closeBreakSubmenu();

function openContextMenu(e, di, ei, si){
  e.preventDefault();
  contextTarget = {di, ei, si};
  const menu = document.getElementById('contextMenu');
  if(!menu) return;

  const pad = 8;
  menu.style.display = 'block';
  const { innerWidth:w, innerHeight:h } = window;
  const rect = menu.getBoundingClientRect();

  let x = e.clientX;
  let y = e.clientY;
  if(x + rect.width + pad > w) x = w - rect.width - pad;
  if(y + rect.height + pad > h) y = h - rect.height - pad;

  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
  menu.setAttribute('aria-hidden','false');
  closeBreakSubmenu();
}
function closeContextMenu(){
  const menu = document.getElementById('contextMenu');
  if(!menu) return;
  menu.style.display = 'none';
  menu.setAttribute('aria-hidden','true');
  contextTarget = null;
  closeBreakSubmenu();
}
function contextSet(val){
  if(!contextTarget) return;
  const {di, ei, si} = contextTarget;
  currentData[di].employees[ei].shifts[si] = val;
  autoSaveWeek();
  render();
  closeContextMenu();
}
function contextWorking(){
  if(!contextTarget) return;
  const {di, ei, si} = contextTarget;
  closeContextMenu();
  const cell = document.querySelector(`.shift-cell[data-di="${di}"][data-ei="${ei}"][data-si="${si}"]`);
  if(cell) editShift(cell, di, ei, si);
}

function openBreakSubmenu(){
  const sub = document.getElementById('breakSubMenu');
  const menu = document.getElementById('contextMenu');
  if(!sub || !menu || menu.style.display !== 'block') return;

  const rect = menu.getBoundingClientRect();
  const pad = 6;
  let x = rect.right + pad;
  let y = rect.top + 70;

  const { innerWidth:w, innerHeight:h } = window;
  sub.style.display = 'block';
  const srect = sub.getBoundingClientRect();
  if(x + srect.width + pad > w) x = rect.left - srect.width - pad;
  if(y + srect.height + pad > h) y = h - srect.height - pad;

  sub.style.left = x + 'px';
  sub.style.top = y + 'px';
  sub.setAttribute('aria-hidden','false');
}
function closeBreakSubmenu(){
  const sub = document.getElementById('breakSubMenu');
  if(!sub) return;
  sub.style.display = 'none';
  sub.setAttribute('aria-hidden','true');
}
function toggleBreakSubmenu(e){
  e.preventDefault();
  const sub = document.getElementById('breakSubMenu');
  if(!sub) return;
  if(sub.style.display === 'block') closeBreakSubmenu();
  else openBreakSubmenu();
}
function contextSetBreak(mins){
  if(!contextTarget) return;
  const {di, ei, si} = contextTarget;
  const raw = currentData[di].employees[ei].shifts[si] || "";
  const parsed = parseBreak(raw);
  const base = normaliseShift(parsed.base || "");

  if(!base || base === 'HOLIDAY' || base === 'SICK'){
    alert('Set a working shift first, then set the break.');
    return;
  }

  currentData[di].employees[ei].shifts[si] = withBreak(base, mins);
  autoSaveWeek();
  render();
  closeBreakSubmenu();
  closeContextMenu();
}
function contextClearBreak(){
  if(!contextTarget) return;
  const {di, ei, si} = contextTarget;
  const raw = currentData[di].employees[ei].shifts[si] || "";
  const parsed = parseBreak(raw);
  const base = normaliseShift(parsed.base || "");
  currentData[di].employees[ei].shifts[si] = base || "";
  autoSaveWeek();
  render();
  closeBreakSubmenu();
  closeContextMenu();
}
function contextFreeTypeBreak(){
  const val = prompt('Enter break in minutes (e.g. 15, 45, 75):');
  if(val === null) return;
  const mins = Number(val);
  if(!Number.isFinite(mins) || mins < 0){
    alert('Please enter a valid number of minutes.');
    return;
  }
  contextSetBreak(Math.round(mins));
}

// Close menu on click elsewhere / escape / scroll
document.addEventListener('click', (e)=>{
  const menu = document.getElementById('contextMenu');
  if(!menu || menu.style.display !== 'block') return;
  if(!menu.contains(e.target)) closeContextMenu();
});
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){ closeContextMenu(); return; }
  if(e.key === 'ArrowLeft' || e.key === 'ArrowRight'){
    const ae = document.activeElement;
    const tag = ae && ae.tagName ? ae.tagName.toUpperCase() : '';
    const typing = tag === 'INPUT' || tag === 'TEXTAREA' || (ae && ae.isContentEditable);
    const inMenu = ae && ae.closest && (ae.closest('#contextMenu') || ae.closest('#breakSubMenu'));
    const menuOpen = (document.getElementById('contextMenu') || {}).style?.display === 'block';
    if(typing || inMenu || menuOpen) return;

    e.preventDefault();
    closeContextMenu();
    if(e.key === 'ArrowLeft') prevWeek.click();
    if(e.key === 'ArrowRight') nextWeek.click();
  }
});
window.addEventListener('scroll', ()=> closeContextMenu(), true);
window.addEventListener('resize', ()=> closeContextMenu());

// --- Buttons / init ---
saveRota.onclick = async () => { await saveCurrentWeekToSheet(); };
prevWeek.onclick = async () => { currentWeekOffset--; await loadWeek(); };
nextWeek.onclick = async () => { currentWeekOffset++; await loadWeek(); };
currentWeek.onclick = async () => { currentWeekOffset=0; await loadWeek(); };

document.getElementById("rotaNotes").addEventListener("input", () => autoSaveWeek());

// initial load
loadWeek();
</script>
